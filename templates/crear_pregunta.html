<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crear Pregunta - Kahoot Style</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>
  <div class="logout-container">
    <a href="/logout" class="logout">Cerrar sesiÃ³n</a>
  </div>

  <div class="main-container">
    <!-- Panel izquierdo: formulario -->
    <div class="left-panel">
      <h2>ğŸ® Crear Cuestionario</h2>

      {% if mensaje %}
      <p class="success">{{ mensaje }}</p>
      {% endif %}

      <!-- Formulario con secciones animadas -->
      <form method="POST" enctype="multipart/form-data" id="mainForm">
        <!-- PASO 1: TÃ­tulo del cuestionario -->
        <div class="form-step active" id="step1">
          <label class="form-label">ğŸ“ TÃ­tulo del cuestionario</label>
          <input type="text" name="titulo" id="titulo" placeholder="Ej: Trivia de Historia" required />
          <div class="step-indicator">Paso 1 de 4</div>
        </div>

        <!-- PASO 2: Tipo de pregunta -->
        <div class="form-step" id="step2">
          <label class="form-label">ğŸ¯ Tipo de pregunta</label>
          <select name="tipo_pregunta" id="tipo_pregunta" required>
            <option value="" selected disabled>Seleccione una opciÃ³n</option>
            <option value="texto">ğŸ“„ Pregunta de texto</option>
            <option value="imagen">ğŸ–¼ï¸ Pregunta con imagen</option>
            <option value="mixta">ğŸ¨ Texto e imagen</option>
          </select>
          <div class="step-indicator">Paso 2 de 4</div>
        </div>

        <!-- PASO 3: Tipo de respuesta -->
        <div class="form-step" id="step3">
          <label class="form-label">âœ… Tipo de respuesta</label>
          <select name="tipo_respuesta" id="tipo_respuesta" required>
            <option value="" selected disabled>Seleccione una opciÃ³n</option>
            <option value="abierta">âœï¸ Respuesta abierta</option>
            <option value="unica">â­• OpciÃ³n mÃºltiple (una correcta)</option>
            <option value="multiple">
              âœ”ï¸ OpciÃ³n mÃºltiple (varias correctas)
            </option>
          </select>
          <div class="step-indicator">Paso 3 de 4</div>
        </div>

        <!-- PASO 4: Contenido de la pregunta -->
        <div class="form-step" id="step4">
          <label class="form-label">â“ Contenido de la pregunta</label>

          <!-- Campo de texto (se muestra segÃºn tipo_pregunta) -->
          <input type="text" id="textoPregunta" name="pregunta" placeholder="Escribe tu pregunta aquÃ­"
            class="content-field" />

          <!-- Campo de imagen (se muestra segÃºn tipo_pregunta) -->
          <div class="file-upload-wrapper" id="imagenWrapper">
            <input type="file" name="imagen" accept="image/*" id="imagenInput" />
            <label for="imagenInput" class="file-label">
              <span class="file-icon">ğŸ“·</span>
              <span class="file-text">Seleccionar imagen</span>
            </label>
            <span class="file-name" id="fileName">No se ha seleccionado archivo</span>
          </div>

          <div id="previewImage" style="margin-top: 10px"></div>

          <div class="step-indicator">Paso 4 de 4</div>
        </div>

        <!-- OPCIONES DE RESPUESTA (solo si no es abierta) -->
        <div id="opciones-container" class="opciones-section">
          <h4 class="opciones-title">ğŸ¯ Opciones de respuesta</h4>
          <p class="opciones-subtitle">Marca las opciones correctas</p>

          <div class="kahoot-option rojo">
            <input type="checkbox" name="correcta" value="1" id="check1" />
            <label for="check1" class="checkbox-label"></label>
            <input type="text" name="opcion1" placeholder="OpciÃ³n 1" />
          </div>

          <div class="kahoot-option azul">
            <input type="checkbox" name="correcta" value="2" id="check2" />
            <label for="check2" class="checkbox-label"></label>
            <input type="text" name="opcion2" placeholder="OpciÃ³n 2" />
          </div>

          <div class="kahoot-option verde">
            <input type="checkbox" name="correcta" value="3" id="check3" />
            <label for="check3" class="checkbox-label"></label>
            <input type="text" name="opcion3" placeholder="OpciÃ³n 3" />
          </div>

          <div class="kahoot-option amarillo">
            <input type="checkbox" name="correcta" value="4" id="check4" />
            <label for="check4" class="checkbox-label"></label>
            <input type="text" name="opcion4" placeholder="OpciÃ³n 4" />
          </div>
        </div>

        <!-- BotÃ³n de guardar pregunta -->
        <button type="button" class="save-btn" id="saveBtn">
          <span class="btn-icon">ğŸ’¾</span>
          <span class="btn-text">Guardar Pregunta</span>
        </button>

        <!-- BotÃ³n de enviar cuestionario completo -->
        <button type="button" class="submit-btn" id="submitAllBtn">
          <span class="btn-icon">ğŸš€</span>
          <span class="btn-text">Finalizar y Enviar Cuestionario</span>
          <span class="btn-loader" id="btnLoader"></span>
        </button>
      </form>
    </div>

    <!-- Panel derecho: lista de preguntas -->
    <div class="right-panel">
      <h3>ğŸ“‹ Preguntas guardadas</h3>

      {% if preguntas %}
      <form method="POST" action="{{ url_for('vaciar_preguntas') }}">
        <button type="submit" class="vaciar-btn">ğŸ—‘ï¸ Vaciar Preguntas</button>
      </form>

      {% for p in preguntas %}
      <div class="pregunta-card">
        <div class="pregunta-titulo">
          <h4>{{ p.pregunta }}</h4>
        </div>

        <div class="opciones-grid">
          {% for o in p.opciones %}
          <div
            class="opcion {% if loop.index == 1 %} rojo {% elif loop.index == 2 %} azul {% elif loop.index == 3 %} verde {% elif loop.index == 4 %} amarillo {% endif %} {% if loop.index == p.correcta|int %} correcta{% endif %}">
            {% if loop.index == p.correcta|int %} âœ… {% endif %} {{ o }}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %} {% else %}
      <div class="empty-state">
        <span class="empty-icon">ğŸ“</span>
        <p class="empty">No hay preguntas creadas aÃºn.</p>
        <p class="empty-hint">
          Completa el formulario para crear tu primera pregunta
        </p>
      </div>
      {% endif %}
    </div>
  </div>
  <script>
    // ğŸ”¹ FunciÃ³n para pintar las preguntas en el panel derecho
    function renderPreguntas() {
      const rightPanel = document.querySelector(".right-panel");
      rightPanel.innerHTML = `
                  <h3>ğŸ“‹ Preguntas guardadas</h3>
                  ${preguntasArray.length > 0
          ? preguntasArray
            .map((p, index) => {
              // Si la imagen se cargÃ³ localmente, mostrarla desde base64
              let imgHTML = "";
              if (p.imagenBase64) {
                imgHTML = `<img src="${p.imagenBase64}" alt="Vista previa"
                                           style="max-width:100%; border-radius:10px; margin-bottom:10px;">`;
              } else if (p.imagen) {
                imgHTML = `<img src="static/uploads/${p.imagen}" alt="Imagen de pregunta"
                                           style="max-width:100%; border-radius:10px; margin-bottom:10px;">`;
              }

              // ConstrucciÃ³n HTML
              return `
                              <div class="pregunta-card">
                                <div class="pregunta-titulo">
                                  <h4>${index + 1}. ${p.pregunta || "Pregunta con imagen"
                }</h4>
                                </div>
                                ${imgHTML}
                                ${p.tipo_respuesta !== "abierta"
                  ? `<div class="opciones-grid">
                                        ${p.opciones
                    .map(
                      (o, i) => `
                                            <div class="opcion ${[
                          "rojo",
                          "azul",
                          "verde",
                          "amarillo",
                        ][i]
                        } ${p.correctas.includes(i + 1)
                          ? "correcta"
                          : ""
                        }">
                                              ${p.correctas.includes(i + 1)
                          ? "âœ… "
                          : ""
                        }${o}
                                            </div>`
                    )
                    .join("")}
                                      </div>`
                  : `<p style="font-style:italic; color:#555;">Respuesta abierta</p>`
                }
                              </div>`;
            })
            .join("")
          : `
                        <div class="empty-state">
                          <span class="empty-icon">ğŸ“</span>
                          <p class="empty">No hay preguntas creadas aÃºn.</p>
                          <p class="empty-hint">
                            Completa el formulario para crear tu primera pregunta
                          </p>
                        </div>
                      `
        }
                `;
    }

    // ğŸ”¹ BotÃ³n para vaciar preguntas guardadas localmente
    document.addEventListener("click", (e) => {
      if (e.target.closest(".vaciar-btn")) {
        e.preventDefault();

        if (preguntasArray.length === 0) {
          alert("No hay preguntas para eliminar ğŸ˜…");
          return;
        }

        if (
          confirm(
            "Â¿Seguro que quieres eliminar todas las preguntas actuales? ğŸ—‘ï¸"
          )
        ) {
          preguntasArray.length = 0; // VacÃ­a el arreglo local
          renderPreguntas(); // Actualiza el panel derecho
          document.getElementById("mainForm").reset(); // Limpia formulario
          document.getElementById("fileName").textContent =
            "No se ha seleccionado archivo";
          document.getElementById("previewImage").innerHTML = "";
          saveBtn.classList.remove("active");

          alert("âœ… Todas las preguntas han sido eliminadas del borrador.");
        }
      }
    });

    const titulo = document.getElementById("titulo");
    const tipoPregunta = document.getElementById("tipo_pregunta");
    const tipoRespuesta = document.getElementById("tipo_respuesta");
    const textoPregunta = document.getElementById("textoPregunta");
    const imagenInput = document.getElementById("imagenInput");
    const imagenWrapper = document.getElementById("imagenWrapper");
    const opcionesContainer = document.getElementById("opciones-container");
    const saveBtn = document.getElementById("saveBtn");
    const submitAllBtn = document.getElementById("submitAllBtn");

    // Mostrar nombre de la imagen seleccionada
    imagenInput.addEventListener("change", (e) => {
      const fileName = document.getElementById("fileName");
      if (imagenInput.files.length > 0) {
        fileName.textContent = imagenInput.files[0].name;
      } else {
        fileName.textContent = "No se ha seleccionado archivo";
      }
    });

    // Previsualizar imagen seleccionada (solo muestra el nombre del archivo)
    imagenInput.addEventListener("change", () => {
      const fileName = document.getElementById("fileName");
      const previewContainer = document.getElementById("previewImage");

      if (imagenInput.files.length > 0) {
        const file = imagenInput.files[0];
        fileName.textContent = file.name;

        // âœ… Mostrar solo el nombre del archivo (sin imagen)
        previewContainer.innerHTML = `
      <p style="color:#333; font-size:14px; margin-top:8px;">
        ğŸ“ <strong>Archivo seleccionado:</strong> ${file.name}
      </p>
    `;
      } else {
        fileName.textContent = "No se ha seleccionado archivo";
        previewContainer.innerHTML = "";
      }
    });

    // ğŸ”¹ Controlar selecciÃ³n Ãºnica o mÃºltiple
    document
      .querySelectorAll("input[name='correcta']")
      .forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (tipoRespuesta.value === "unica") {
            // Desmarcar todos los demÃ¡s si es "una correcta"
            document
              .querySelectorAll("input[name='correcta']")
              .forEach((cb) => {
                if (cb !== checkbox) cb.checked = false;
              });
          }
        });
      });

    const steps = {
      step1: document.getElementById("step1"),
      step2: document.getElementById("step2"),
      step3: document.getElementById("step3"),
      step4: document.getElementById("step4"),
    };

    saveBtn.classList.remove("active");

    // Mostrar paso 2
    titulo.addEventListener("input", function () {
      if (this.value.trim().length > 0) {
        // Mostrar el paso 2 cuando hay texto en el tÃ­tulo
        steps.step2.classList.add("active");
      } else {
        // Si se borra el texto, mantener visible el paso 1
        steps.step1.classList.add("active");
        steps.step2.classList.remove("active");
        steps.step3.classList.remove("active");
        steps.step4.classList.remove("active");
        saveBtn.disabled = true;
        saveBtn.classList.add("disabled-btn");
      }
    });

    // Mostrar paso 3
    tipoPregunta.addEventListener("change", function () {
      if (this.value) steps.step3.classList.add("active");

      const valor = this.value;
      if (valor === "texto") {
        textoPregunta.style.display = "block";
        textoPregunta.required = true;
        imagenWrapper.style.display = "none";
        imagenInput.required = false;
      } else if (valor === "imagen") {
        textoPregunta.style.display = "none";
        textoPregunta.required = false;
        imagenWrapper.style.display = "flex";
        imagenInput.required = true;
      } else if (valor === "mixta") {
        textoPregunta.style.display = "block";
        textoPregunta.required = true;
        imagenWrapper.style.display = "flex";
        imagenInput.required = true;
      }
    });

    // Mostrar paso 4
    tipoRespuesta.addEventListener("change", function () {
      if (this.value) {
        steps.step4.classList.add("active");

        if (this.value === "abierta") {
          opcionesContainer.classList.remove("active");
          opcionesContainer.style.display = "none";
        } else {
          setTimeout(() => {
            opcionesContainer.style.display = "block";
            opcionesContainer.classList.add("active");
          }, 200);
        }

        // habilitar botÃ³n guardar
        saveBtn.classList.add("active");
      }
    });

    const preguntasArray = [];

    // btn guardar
    saveBtn.addEventListener("click", () => {
      try {
        // Validar pasos previos
        if (!titulo.value.trim()) return alert("Debes ingresar un tÃ­tulo.");
        if (!tipoPregunta.value)
          return alert("Selecciona un tipo de pregunta.");
        if (!tipoRespuesta.value)
          return alert("Selecciona un tipo de respuesta.");

        // Crear objeto base
        const preguntaObj = {
          tipo_pregunta: tipoPregunta.value,
          tipo_respuesta: tipoRespuesta.value,
          pregunta: textoPregunta.value.trim(),
          opciones: [],
          correctas: [],
          imagen: null,
        };

        // Validar pregunta e imagen
        if (tipoPregunta.value === "texto" && !preguntaObj.pregunta)
          return alert("Debes escribir el texto de la pregunta.");

        if (
          tipoPregunta.value === "imagen" ||
          tipoPregunta.value === "mixta"
        ) {
          if (!imagenInput.files.length)
            return alert("Debes seleccionar una imagen para esta pregunta.");
          preguntaObj.imagen = imagenInput.files[0].name;
        }

        // Validar opciones (solo si no es abierta)
        if (tipoRespuesta.value !== "abierta") {
          for (let i = 1; i <= 4; i++) {
            const opcionCampo = document.querySelector(
              `input[name="opcion${i}"]`
            );
            const checkCampo = document.querySelector(`#check${i}`);
            if (opcionCampo && opcionCampo.value.trim() !== "") {
              preguntaObj.opciones.push(opcionCampo.value.trim());
              if (checkCampo && checkCampo.checked)
                preguntaObj.correctas.push(i);
            }
          }

          if (preguntaObj.opciones.length < 2)
            return alert("Debes agregar al menos 2 opciones vÃ¡lidas.");
          if (preguntaObj.correctas.length === 0)
            return alert("Debes marcar al menos una opciÃ³n correcta.");
        }

        if (imagenInput.files.length > 0) {
          const file = imagenInput.files[0];
          const reader = new FileReader();
          reader.onload = function (e) {
            preguntaObj.imagenBase64 = e.target.result; // Guardamos el base64
            preguntasArray.push(preguntaObj);
            renderPreguntas();
          };
          reader.readAsDataURL(file);
        } else {
          preguntasArray.push(preguntaObj);
          renderPreguntas();
        }

        // Limpiar formulario
        textoPregunta.value = "";
        imagenInput.value = "";
        document.querySelector("#fileName").textContent =
          "No se ha seleccionado archivo";
        document
          .querySelectorAll("input[type='checkbox']")
          .forEach((el) => (el.checked = false));
        document
          .querySelectorAll("input[type='text'][name^='opcion']")
          .forEach((el) => (el.value = ""));
      } catch (error) {
        console.error("âŒ Error al guardar:", error);
        alert("OcurriÃ³ un error al guardar la pregunta.");
      }
    });

    // Enviar cuestionario completo
    submitAllBtn.addEventListener("click", async () => {
      if (preguntasArray.length === 0) {
        alert("No hay preguntas para enviar ğŸ˜…");
        return;
      }

      const formData = new FormData();
      formData.append("titulo", titulo.value);
      formData.append("preguntas", JSON.stringify(preguntasArray));

      submitAllBtn.classList.add("loading");
      submitAllBtn.disabled = true;

      try {
        const response = await fetch("/guardarEncuesta", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (response.ok) {
          alert("ğŸ‰ Cuestionario guardado correctamente");
          console.log("ğŸ“¦ Respuesta servidor:", result);

          setTimeout(() => {
            location.reload(); // ğŸ”„ recarga toda la pÃ¡gina
          }, 800);

        } else {
          alert("âŒ Error al guardar cuestionario: " + result.message);
        }
      } catch (err) {
        console.error("âš ï¸ Error de conexiÃ³n:", err);
        alert("Error de conexiÃ³n con el servidor");
      } finally {
        submitAllBtn.classList.remove("loading");
        submitAllBtn.disabled = false;
      }
    });
  </script>
</body>

</html>